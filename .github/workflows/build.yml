name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact: win32-x64
          - os: windows-11-arm
            artifact: win32-arm64
          - os: ubuntu-latest
            artifact: linux-x64
          - os: ubuntu-24.04-arm
            artifact: linux-arm64
          - os: macos-latest
            artifact: darwin-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Run tests
        run: |
          cd tests
          npm install
          npm test

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: ctypes-${{ matrix.artifact }}
          path: build/Release/ctypes.node

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Assemble multi-platform package
        run: |
          mkdir -p package/lib
          mkdir -p package/build/Release
          
          # Copy platform-specific binaries
          for dir in artifacts/ctypes-*; do
            if [ -d "$dir" ]; then
              platform=$(basename "$dir" | sed 's/ctypes-//')
              cp "$dir/ctypes.node" "package/build/Release/ctypes-${platform}.node"
            fi
          done
          
          # Copy source files
          cp -r lib/* package/lib/
          cp package.json README.md LICENSE package/

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v6
        with:
          name: node-ctypes
          path: package/
