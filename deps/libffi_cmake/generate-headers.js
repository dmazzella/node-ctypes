#!/usr/bin/env node
/**
 * generate-ffi-headers.js
 *
 * Generates unified ffi.h and fficonfig.h from libffi sources.
 * Run this script after updating deps/libffi to regenerate the headers.
 *
 * Usage: node scripts/generate-ffi-headers.js
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const LIBFFI_DIR = path.join(__dirname, "..", "libffi");
const OUTPUT_DIR = path.join(__dirname, "fficonfig");

/**
 * Extract version info from configure.ac
 */
function extractVersion() {
  const configureAc = fs.readFileSync(
    path.join(LIBFFI_DIR, "configure.ac"),
    "utf8",
  );

  const versionStringMatch = configureAc.match(/FFI_VERSION_STRING="([^"]+)"/);
  const versionNumberMatch = configureAc.match(/FFI_VERSION_NUMBER=(\d+)/);

  if (!versionStringMatch || !versionNumberMatch) {
    throw new Error("Could not extract version from configure.ac");
  }

  return {
    string: versionStringMatch[1],
    number: parseInt(versionNumberMatch[1], 10),
  };
}

/**
 * Generate fficonfig.h
 */
function generateFficonfig(version) {
  return `/* ============================================================================
 * fficonfig.h - Unified configuration for libffi (node-ctypes)
 * ============================================================================
 *
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Generated by: scripts/generate-ffi-headers.js
 * From libffi version: ${version.string}
 *
 * This file replaces the autotools-generated fficonfig.h with a unified
 * version that uses preprocessor macros for platform detection.
 *
 * ============================================================================
 */

#ifndef FFICONFIG_H
#define FFICONFIG_H

/* Package information */
#define PACKAGE "libffi"
#define PACKAGE_NAME "libffi"
#define PACKAGE_VERSION "${version.string}"
#define PACKAGE_STRING "libffi ${version.string}"
#define PACKAGE_TARNAME "libffi"
#define PACKAGE_BUGREPORT "http://github.com/libffi/libffi/issues"
#define PACKAGE_URL ""
#define VERSION "${version.string}"

/* ============================================================================
 * Platform Detection
 * ============================================================================
 */

/* Windows */
#if defined(_WIN32) || defined(_WIN64) || defined(__CYGWIN__)
#  define FFI_PLATFORM_WINDOWS 1
#endif

/* macOS */
#if defined(__APPLE__) && defined(__MACH__)
#  define FFI_PLATFORM_MACOS 1
#  define MACOSX 1
#endif

/* Linux */
#if defined(__linux__)
#  define FFI_PLATFORM_LINUX 1
#endif

/* ============================================================================
 * Architecture Detection
 * ============================================================================
 */

/* x86-64 (AMD64) */
#if defined(__x86_64__) || defined(_M_X64) || defined(__amd64__)
#  define FFI_ARCH_X86_64 1
#  define SIZEOF_SIZE_T 8
#endif

/* ARM64 (AArch64) */
#if defined(__aarch64__) || defined(_M_ARM64)
#  define FFI_ARCH_AARCH64 1
#  define SIZEOF_SIZE_T 8
#endif

/* ARM32 */
#if defined(__arm__) || defined(_M_ARM)
#  define FFI_ARCH_ARM 1
#  define SIZEOF_SIZE_T 4
#endif

/* x86 (32-bit) */
#if defined(__i386__) || defined(_M_IX86)
#  define FFI_ARCH_X86 1
#  define SIZEOF_SIZE_T 4
#endif

/* ============================================================================
 * Common Configuration
 * ============================================================================
 */

/* Standard C library features */
#define STDC_HEADERS 1
#define HAVE_STDINT_H 1
#define HAVE_INTTYPES_H 1
#define HAVE_STRING_H 1
#define HAVE_MEMORY_H 1
#define HAVE_MEMCPY 1

/* Data type sizes */
#define SIZEOF_DOUBLE 8

/* Long double size varies by platform */
#if defined(FFI_PLATFORM_WINDOWS)
#  define SIZEOF_LONG_DOUBLE 8
#  define HAVE_LONG_DOUBLE 1
#elif defined(FFI_PLATFORM_MACOS)
#  if defined(FFI_ARCH_AARCH64)
#    define SIZEOF_LONG_DOUBLE 8
#  else
#    define SIZEOF_LONG_DOUBLE 16
#  endif
#  define HAVE_LONG_DOUBLE 1
#else
#  define SIZEOF_LONG_DOUBLE 16
#  define HAVE_LONG_DOUBLE 1
#endif

/* ============================================================================
 * Platform-Specific Configuration
 * ============================================================================
 */

#if defined(FFI_PLATFORM_WINDOWS)
/*
 * Windows configuration
 */

/* No mmap on Windows - use VirtualAlloc */
/* #undef HAVE_MMAP */
/* #undef HAVE_MMAP_ANON */
/* #undef HAVE_MMAP_DEV_ZERO */
/* #undef HAVE_MMAP_FILE */
/* #undef HAVE_SYS_MMAN_H */

/* No dlfcn on Windows */
/* #undef HAVE_DLFCN_H */

/* Windows has alloca via _alloca */
#define HAVE_ALLOCA 1
/* #undef HAVE_ALLOCA_H */

/* No unistd.h on Windows */
/* #undef HAVE_UNISTD_H */

/* Symbols are not underscored on Win64 */
#if defined(FFI_ARCH_X86)
#  define SYMBOL_UNDERSCORE 1
#endif

#else /* Unix-like systems (Linux, macOS) */
/*
 * Unix configuration
 */

/* Memory mapping */
#define HAVE_MMAP 1
#define HAVE_MMAP_ANON 1
#define HAVE_MMAP_FILE 1
#define HAVE_SYS_MMAN_H 1

/* Dynamic loading */
#define HAVE_DLFCN_H 1

/* alloca */
#define HAVE_ALLOCA 1
#define HAVE_ALLOCA_H 1

/* Unix headers */
#define HAVE_UNISTD_H 1
#define HAVE_SYS_STAT_H 1
#define HAVE_SYS_TYPES_H 1
#define HAVE_STRINGS_H 1

/* mkostemp */
#define HAVE_MKOSTEMP 1

#if defined(FFI_PLATFORM_LINUX)
#  define HAVE_MMAP_DEV_ZERO 1
#endif

#endif /* Windows vs Unix */

/* ============================================================================
 * Compiler-Specific Configuration
 * ============================================================================
 */

#if defined(_MSC_VER) && !defined(__clang__)
/*
 * MSVC-specific
 */

/* MSVC doesn't have visibility attributes */
/* #undef HAVE_HIDDEN_VISIBILITY_ATTRIBUTE */

#else
/*
 * GCC/Clang
 */

/* Symbol visibility */
#define HAVE_HIDDEN_VISIBILITY_ATTRIBUTE 1

/* Assembler features */
#define HAVE_AS_CFI_PSEUDO_OP 1

#if defined(FFI_ARCH_X86_64) && !defined(FFI_PLATFORM_WINDOWS)
#  define HAVE_AS_X86_PCREL 1
#endif

#endif /* MSVC vs GCC/Clang */

/* ============================================================================
 * Feature Configuration
 * ============================================================================
 */

/* Read-only .eh_frame sections */
#if !defined(FFI_PLATFORM_WINDOWS)
#  define HAVE_RO_EH_FRAME 1
#  define EH_FRAME_FLAGS "a"
#endif

/* No raw API restrictions */
/* #undef FFI_NO_RAW_API */

/* No struct restrictions */
/* #undef FFI_NO_STRUCTS */

/* No special exec table needed */
/* #undef FFI_EXEC_TRAMPOLINE_TABLE */

/* No mmap exec workarounds needed */
/* #undef FFI_MMAP_EXEC_WRIT */
/* #undef FFI_MMAP_EXEC_EMUTRAMP_PAX */

/* No debug by default */
/* #undef FFI_DEBUG */

/* ============================================================================
 * FFI_HIDDEN Macro Definition
 * ============================================================================
 */

#ifdef HAVE_HIDDEN_VISIBILITY_ATTRIBUTE
#  ifdef LIBFFI_ASM
#    ifdef __APPLE__
#      define FFI_HIDDEN(name) .private_extern name
#    else
#      define FFI_HIDDEN(name) .hidden name
#    endif
#  else
#    define FFI_HIDDEN __attribute__((visibility("hidden")))
#  endif
#else
#  ifdef LIBFFI_ASM
#    define FFI_HIDDEN(name)
#  else
#    define FFI_HIDDEN
#  endif
#endif

/* ============================================================================
 * Libtool stuff (not used but some code checks for it)
 * ============================================================================
 */

#define LT_OBJDIR ".libs/"

#endif /* FFICONFIG_H */
`;
}

/**
 * Generate ffi.h from ffi.h.in template
 */
function generateFfiH(version) {
  let template = fs.readFileSync(
    path.join(LIBFFI_DIR, "include", "ffi.h.in"),
    "utf8",
  );

  // Build the platform detection header
  const platformDetection = `/* ============================================================================
 * Platform/Architecture Detection and Target Definition
 * ============================================================================
 *
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Generated by: scripts/generate-ffi-headers.js
 * From libffi version: ${version.string}
 *
 * ============================================================================
 */

/* Detect architecture and define target */
#if defined(__x86_64__) || defined(_M_X64) || defined(__amd64__)
#  if defined(_WIN32) || defined(_WIN64)
#    ifndef X86_WIN64
#      define X86_WIN64
#    endif
#  else
#    ifndef X86_64
#      define X86_64
#    endif
#  endif
#elif defined(__aarch64__) || defined(_M_ARM64)
#  ifndef AARCH64
#    define AARCH64
#  endif
#elif defined(__arm__) || defined(_M_ARM)
#  ifndef ARM
#    define ARM
#  endif
#elif defined(__i386__) || defined(_M_IX86)
#  if defined(_WIN32)
#    ifndef X86_WIN32
#      define X86_WIN32
#    endif
#  else
#    ifndef X86
#      define X86
#    endif
#  endif
#endif`;

  // Build the ffitarget include logic
  const ffitargetInclude = `/* Include the appropriate ffitarget.h based on architecture */
#if defined(X86_WIN64) || defined(X86_64) || defined(X86_WIN32) || defined(X86)
#  include "x86/ffitarget.h"
#elif defined(AARCH64)
#  include "aarch64/ffitarget.h"
#elif defined(ARM)
#  include "arm/ffitarget.h"
#else
#  error "Unsupported architecture for libffi"
#endif`;

  let output = template;

  // Update version in copyright header
  output = output.replace(/libffi @VERSION@/g, `libffi ${version.string}`);

  // Replace @TARGET@ block with platform detection
  output = output.replace(
    /\/\* Specify which architecture libffi is configured for\. \*\/\s*#ifndef @TARGET@\s*#define @TARGET@\s*#endif/,
    platformDetection,
  );

  // Replace @HAVE_LONG_DOUBLE@ - always 1 for our platforms
  output = output.replace(/@HAVE_LONG_DOUBLE@/g, "1");

  // Replace @FFI_EXEC_TRAMPOLINE_TABLE@ - 0 for our platforms
  output = output.replace(/@FFI_EXEC_TRAMPOLINE_TABLE@/g, "0");

  // Replace version placeholders
  output = output.replace(/@FFI_VERSION_STRING@/g, version.string);
  output = output.replace(/@FFI_VERSION_NUMBER@/g, version.number.toString());

  // Replace #include <ffitarget.h> with our conditional include
  output = output.replace(/#include <ffitarget\.h>/, ffitargetInclude);

  // Remove __attribute__((deprecated)) from java_raw functions (MSVC doesn't support it)
  // We wrap them with #ifndef _MSC_VER
  output = output.replace(
    /(\s+)__attribute__\(\(deprecated\)\);/g,
    "\n#if defined(__GNUC__)\n  __attribute__((deprecated))\n#endif\n  ;",
  );

  return output;
}

/**
 * Main
 */
function main() {
  console.log("Generating libffi headers for node-ctypes...\n");

  // Check if libffi sources exist
  if (!fs.existsSync(path.join(LIBFFI_DIR, "configure.ac"))) {
    console.error("Error: libffi sources not found at", LIBFFI_DIR);
    console.error("Please ensure deps/libffi contains the libffi source code.");
    process.exit(1);
  }

  // Extract version
  const version = extractVersion();
  console.log(`libffi version: ${version.string} (${version.number})`);

  // Ensure output directory exists
  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  // Generate fficonfig.h
  const fficonfig = generateFficonfig(version);
  const fficonfigPath = path.join(OUTPUT_DIR, "fficonfig.h");
  fs.writeFileSync(fficonfigPath, fficonfig);
  console.log(`Generated: ${fficonfigPath}`);

  // Generate ffi.h
  const ffiH = generateFfiH(version);
  const ffiHPath = path.join(OUTPUT_DIR, "ffi.h");
  fs.writeFileSync(ffiHPath, ffiH);
  console.log(`Generated: ${ffiHPath}`);

  console.log("\nDone! Headers generated successfully.");
  console.log('Run "npm run rebuild" to rebuild with the new headers.');
}

main();
